#include <stdint.h>
#include <stdio.h>
#include <math.h>
#include "radix_ntt_n761.h"
#include "../poly.h"
#include "../inverse.h"

int32_t zetas_n761[N_N761 / 3] = {
    5592919, 33026177, 26790957, 33026177, 13499153, 21938565, 26790957, 33026177, 10764447, 19493511, 9265027, 5611999, 13499153, 21938565, 26790957, 33026177,
    31350138, 24124141, 10149685, 3198144, 32900457, 1140056, 24000204, 27372525, 10764447, 19493511, 9265027, 5611999, 13499153, 21938565, 26790957, 33026177,
    32738467, 16657861, 28138468, 501067, 16015129, 21620241, 1529124, 28870577, 18285219, 3050639, 27906268, 21100145, 5343767, 15280732, 12498775, 17354707,
    31350138, 24124141, 10149685, 3198144, 32900457, 1140056, 24000204, 27372525, 10764447, 19493511, 9265027, 5611999, 13499153, 21938565, 26790957, 33026177,
    9795452, 12096975, 33505735, 10865068, 16076627, 23564159, 31258325, 19464215, 24580770, 6067746, 18546326, 875322, 23054283, 15379670, 17941644, 2515533,
    17182522, 9742026, 11427911, 16642093, 24272961, 6983968, 22883012, 17558876, 10658623, 29624690, 1466133, 20016426, 18447657, 8460173, 19793647, 24333065,
    32738467, 16657861, 28138468, 501067, 16015129, 21620241, 1529124, 28870577, 18285219, 3050639, 27906268, 21100145, 5343767, 15280732, 12498775, 17354707,
    31350138, 24124141, 10149685, 3198144, 32900457, 1140056, 24000204, 27372525, 10764447, 19493511, 9265027, 5611999, 13499153, 21938565, 26790957, 33026177,
    10420445, 32038148, 2264, 33265110, 25958325, 11902971, 25622482, 27761690, 28792776, 33361188, 24969419, 12394212, 33193998, 6229980, 8743221, 4457820,
    28382998, 8431289, 1312494, 4681025, 29392120, 295408, 2951574, 9444158, 16620023, 32579155, 31375729, 11964204, 33164555, 16089224, 25578586, 22029388,
    19233249, 12984689, 30813171, 15944111, 13539352, 27143752, 7098522, 30855744, 15029351, 2274807, 31244694, 16958068, 23199393, 17755942, 6583826, 30969403,
    1918505, 22360437, 26047052, 3762725, 10986757, 5860566, 28381447, 3454840, 31955344, 13111549, 10268342, 11767139, 6958801, 13085226, 6345790, 33276057,
    9795452, 12096975, 33505735, 10865068, 16076627, 23564159, 31258325, 19464215, 24580770, 6067746, 18546326, 875322, 23054283, 15379670, 17941644, 2515533,
    17182522, 9742026, 11427911, 16642093, 24272961, 6983968, 22883012, 17558876, 10658623, 29624690, 1466133, 20016426, 18447657, 8460173, 19793647, 24333065,
    32738467, 16657861, 28138468, 501067, 16015129, 21620241, 1529124, 28870577, 18285219, 3050639, 27906268, 21100145, 5343767, 15280732, 12498775, 17354707,
    31350138, 24124141, 10149685, 3198144, 32900457, 1140056, 24000204, 27372525, 10764447, 19493511, 9265027, 5611999, 13499153, 21938565, 26790957, 33026177,
    5592919, 31075518, 21303665, 22682749, 11872764, 2432073, 19322199, 11292275, 23696636, 32659557, 23346277, 31556495, 21579819, 5882189, 6581391, 32328326,
    10696307, 16874833, 31719194, 6911566, 29285890, 23963075, 31256330, 9623777, 31413463, 32254537, 11613809, 24253081, 24356853, 24689701, 17056149, 15482269,
    10167038, 22751501, 18535303, 3968231, 1394219, 26379347, 16811031, 28313524, 16967280, 23729319, 31158593, 2331434, 549280, 18765598, 27900090, 4955113,
    1126043, 7409310, 26996082, 3493835, 5276286, 25397512, 30230071, 26868776, 1340079, 15120857, 24105137, 12241024, 12565260, 33504217, 7283953, 25114323,
    7865111, 32661754, 22892358, 6749048, 9488390, 10088648, 22153949, 5957087, 6543554, 17785943, 9563220, 4840264, 22490456, 6137845, 17318481, 17583519,
    24218356, 23955081, 26738484, 22876568, 3544406, 28057775, 18074286, 26082996, 32554080, 21141507, 15212341, 7347621, 25101513, 16054630, 18249116, 7050722,
    2250785, 7291436, 3750223, 26357349, 10321733, 17918503, 8792503, 33073869, 21274321, 10730693, 6218037, 32966155, 23321992, 20997298, 25154884, 8989918,
    5527986, 7143126, 31109078, 27760189, 9686871, 5400208, 13544313, 4038243, 9254376, 26381630, 18797971, 13377401, 350844, 19639872, 20608463, 28613855,
    10420445, 32038148, 2264, 33265110, 25958325, 11902971, 25622482, 27761690, 28792776, 33361188, 24969419, 12394212, 33193998, 6229980, 8743221, 4457820,
    28382998, 8431289, 1312494, 4681025, 29392120, 295408, 2951574, 9444158, 16620023, 32579155, 31375729, 11964204, 33164555, 16089224, 25578586, 22029388,
    19233249, 12984689, 30813171, 15944111, 13539352, 27143752, 7098522, 30855744, 15029351, 2274807, 31244694, 16958068, 23199393, 17755942, 6583826, 30969403,
    1918505, 22360437, 26047052, 3762725, 10986757, 5860566, 28381447, 3454840, 31955344, 13111549, 10268342, 11767139, 6958801, 13085226, 6345790, 33276057,
    9795452, 12096975, 33505735, 10865068, 16076627, 23564159, 31258325, 19464215, 24580770, 6067746, 18546326, 875322, 23054283, 15379670, 17941644, 2515533,
    17182522, 9742026, 11427911, 16642093, 24272961, 6983968, 22883012, 17558876, 10658623, 29624690, 1466133, 20016426, 18447657, 8460173, 19793647, 24333065,
    32738467, 16657861, 28138468, 501067, 16015129, 21620241, 1529124, 28870577, 18285219, 3050639, 27906268, 21100145, 5343767, 15280732, 12498775, 17354707,
    31350138, 24124141, 10149685, 3198144, 32900457, 1140056, 24000204, 27372525, 10764447, 19493511, 9265027, 5611999, 13499153, 21938565, 26790957, 33026177};

int32_t zetas_inv_n761[N_N761 / 3] = {
    4936482, 12941874, 13910465, 33199493, 20172936, 14752366, 7168707, 24295961, 29512094, 20006024, 28150129, 23863466, 5790148, 2441259, 26407211, 28022351,
    24560419, 8395453, 12553039, 10228345, 584182, 27332300, 22819644, 12276016, 476468, 24757834, 15631834, 23228604, 7192988, 29800114, 26258901, 31299552,
    26499615, 15301221, 17495707, 8448824, 26202716, 18337996, 12408830, 996257, 7467341, 15476051, 5492562, 30005931, 10673769, 6811853, 9595256, 9331981,
    15966818, 16231856, 27412492, 11059881, 28710073, 23987117, 15764394, 27006783, 27593250, 11396388, 23461689, 24061947, 26801289, 10657979, 888583, 25685226,
    8436014, 26266384, 46120, 20985077, 21309313, 9445200, 18429480, 32210258, 6681561, 3320266, 8152825, 28274051, 30056502, 6554255, 26141027, 32424294,
    28595224, 5650247, 14784739, 33001057, 31218903, 2391744, 9821018, 16583057, 5236813, 16739306, 7170990, 32156118, 29582106, 15015034, 10798836, 23383299,
    18068068, 16494188, 8860636, 9193484, 9297256, 21936528, 1295800, 2136874, 23926560, 2294007, 9587262, 4264447, 26638771, 1831143, 16675504, 22854030,
    1222011, 26968946, 27668148, 11970518, 1993842, 10204060, 890780, 9853701, 22258062, 14228138, 31118264, 21677573, 10867588, 12246672, 2474819, 27957418,
    274280, 27204547, 20465111, 26591536, 21783198, 23281995, 20438788, 1594993, 30095497, 5168890, 27689771, 22563580, 29787612, 7503285, 11189900, 31631832,
    2580934, 26966511, 15794395, 10350944, 16592269, 2305643, 31275530, 18520986, 2694593, 26451815, 6406585, 20010985, 17606226, 2737166, 20565648, 14317088,
    11520949, 7971751, 17461113, 385782, 21586133, 2174608, 971182, 16930314, 24106179, 30598763, 33254929, 4158217, 28869312, 32237843, 25119048, 5167339,
    29092517, 24807116, 27320357, 356339, 21156125, 8580918, 189149, 4757561, 5788647, 7927855, 21647366, 7592012, 285227, 33548073, 1512189, 23129892,
    9217272, 13756690, 25090164, 15102680, 13533911, 32084204, 3925647, 22891714, 15991461, 10667325, 26566369, 9277376, 16908244, 22122426, 23808311, 16367815,
    31034804, 15608693, 18170667, 10496054, 32675015, 15004011, 27482591, 8969567, 14086122, 2292012, 9986178, 17473710, 22685269, 44602, 21453362, 23754885,
    16195630, 21051562, 18269605, 28206570, 12450192, 5644069, 30499698, 15265118, 4679760, 32021213, 11930096, 17535208, 33049270, 5411869, 16892476, 811870,
    6177812, 9550133, 32410281, 649880, 30352193, 23400652, 9426196, 2200199, 27938338, 24285310, 14056826, 22785890, 11611772, 20051184, 6759380, 33026177,
    274280, 27204547, 20465111, 26591536, 21783198, 23281995, 20438788, 1594993, 30095497, 5168890, 27689771, 22563580, 29787612, 7503285, 11189900, 31631832,
    2580934, 26966511, 15794395, 10350944, 16592269, 2305643, 31275530, 18520986, 2694593, 26451815, 6406585, 20010985, 17606226, 2737166, 20565648, 14317088,
    11520949, 7971751, 17461113, 385782, 21586133, 2174608, 971182, 16930314, 24106179, 30598763, 33254929, 4158217, 28869312, 32237843, 25119048, 5167339,
    29092517, 24807116, 27320357, 356339, 21156125, 8580918, 189149, 4757561, 5788647, 7927855, 21647366, 7592012, 285227, 33548073, 1512189, 23129892,
    9217272, 13756690, 25090164, 15102680, 13533911, 32084204, 3925647, 22891714, 15991461, 10667325, 26566369, 9277376, 16908244, 22122426, 23808311, 16367815,
    31034804, 15608693, 18170667, 10496054, 32675015, 15004011, 27482591, 8969567, 14086122, 2292012, 9986178, 17473710, 22685269, 44602, 21453362, 23754885,
    16195630, 21051562, 18269605, 28206570, 12450192, 5644069, 30499698, 15265118, 4679760, 32021213, 11930096, 17535208, 33049270, 5411869, 16892476, 811870,
    6177812, 9550133, 32410281, 649880, 30352193, 23400652, 9426196, 2200199, 27938338, 24285310, 14056826, 22785890, 11611772, 20051184, 6759380, 33026177,
    9217272, 13756690, 25090164, 15102680, 13533911, 32084204, 3925647, 22891714, 15991461, 10667325, 26566369, 9277376, 16908244, 22122426, 23808311, 16367815,
    31034804, 15608693, 18170667, 10496054, 32675015, 15004011, 27482591, 8969567, 14086122, 2292012, 9986178, 17473710, 22685269, 44602, 21453362, 23754885,
    16195630, 21051562, 18269605, 28206570, 12450192, 5644069, 30499698, 15265118, 4679760, 32021213, 11930096, 17535208, 33049270, 5411869, 16892476, 811870,
    6177812, 9550133, 32410281, 649880, 30352193, 23400652, 9426196, 2200199, 27938338, 24285310, 14056826, 22785890, 11611772, 20051184, 6759380, 33026177,
    16195630, 21051562, 18269605, 28206570, 12450192, 5644069, 30499698, 15265118, 4679760, 32021213, 11930096, 17535208, 33049270, 5411869, 16892476, 811870,
    6177812, 9550133, 32410281, 649880, 30352193, 23400652, 9426196, 2200199, 27938338, 24285310, 14056826, 22785890, 11611772, 20051184, 6759380, 33026177,
    6177812, 9550133, 32410281, 649880, 30352193, 23400652, 9426196, 2200199, 27938338, 24285310, 14056826, 22785890, 11611772, 20051184, 6759380, 33026177,
    27938338, 24285310, 14056826, 22785890, 11611772, 20051184, 6759380, 33026177, 11611772, 20051184, 6759380, 33026177, 6759380, 33026177, 33026177};

int32_t pseudomersenne_reduce_double_n761(int64_t a)
{
    int32_t t0, t1;
    int64_t t;

    t0 = a & 0x1ffffff;
    t1 = a >> 25;
    t = (t1 << 12) + t0 - t1;

    t0 = t & 0x1ffffff;
    t1 = t >> 25;
    t = (t1 << 12) + t0 - t1 - Q_N761;

    return (int32_t)t;
}

int32_t pseudomersenne_reduce_single_n761(int32_t a)
{
    int32_t t0, t1;
    t0 = a & 0x1ffffff;
    t1 = a >> 25;
    t0 = (t1 << 12) + t0 - t1 - Q_N761;
    return t0;
}

int32_t montgomery_reduce_n761(int64_t a)
{
    int32_t t;
    t = (int32_t)a * NUMBER_QCMOSSH;
    t = (a - (int64_t)t * Q_N761) >> 32;
    return t;
}

void ntt_big_n761(int32_t a[N_N761])
{
    unsigned int len, start, j, k;
    int32_t zeta, t;

    
    len = N_N761 / 2;
    for (start = 0; start < N_N761; start = j + len)
    {
        for (j = start; j < start + len; ++j)
        {
            t = a[j + len];
            a[j + len] = (a[j] + t);
            a[j] = (a[j] - t);
        }
    }

    k = 2;
    
    for (len = N_N761 / 4; len >= 3; len >>= 1)
    {
        for (start = 0; start < N_N761; start = j + len)
        {
            zeta = zetas_n761[k++];

            if (zeta == NUMBER_CINFGSK)
            {
                for (j = start; j < start + len; ++j)
                {
                    t = a[j + len];
                    a[j + len] = (a[j] + t);
                    a[j] = pseudomersenne_reduce_single_n761(a[j] - t);
                }
            }
            else
            {
                for (j = start; j < start + len; ++j)
                {
                    t = montgomery_reduce_n761((int64_t)zeta * a[j + len]);
                    a[j + len] = (a[j] - t);
                    a[j] = (a[j] + t);
                }
            }
        }
    }
}

void ntt_small_n761(int32_t a[N_N761])
{
    unsigned int len, start, j, k;
    int32_t zeta, t;

    
    len = N_N761 / 2;
    for (start = 0; start < N_N761; start = j + len)
    {
        for (j = start; j < start + len; ++j)
        {
            t = a[j + len];
            a[j + len] = (a[j] + t);
            a[j] = (a[j] - t);
        }
    }

    k = 2;
    
    len = N_N761 / 4;
    start = 0;
    for (j = start; j < start + len; ++j)
    {
        t = FACTOR_CONFIHLNHM * a[j + len];
        a[j + len] = (a[j] - t);
        a[j] = (a[j] + t);
    }

    start += 2 * len;
    for (j = start; j < start + len; ++j)
    {
        t = a[j + len];
        a[j + len] = (a[j] + t);
        a[j] = (a[j] - t);
    }
    k += 2;

    
    for (len = N_N761 / 8; len >= 3; len >>= 1)
    {
        for (start = 0; start < N_N761; start = j + len)
        {
            zeta = zetas_n761[k++];

            if (zeta == NUMBER_CINFGSK)
            {
                for (j = start; j < start + len; ++j)
                {
                    t = a[j + len];
                    a[j + len] = (a[j] + t);
                    a[j] = pseudomersenne_reduce_single_n761(a[j] - t);
                }
            }
            else
            {
                for (j = start; j < start + len; ++j)
                {
                    t = montgomery_reduce_n761((int64_t)zeta * a[j + len]);
                    a[j + len] = (a[j] - t);
                    a[j] = (a[j] + t);
                }
            }
        }
    }
}

void invntt_toNUMBER_CONDSH(int32_t a[N_N761])
{
    unsigned int start, len, j, k;
    int32_t t, zeta;

    k = 0;

    
    for (len = 3; len <= N_N761 / 4; len <<= 1)
    {
        if (len == (3 << 3))
        {
            for (j = 0; j < N_N761; j++)
                a[j] = pseudomersenne_reduce_single_n761(a[j]);
        }

        for (start = 0; start < N_N761; start = j + len)
        {
            zeta = zetas_inv_n761[k++];

            if (zeta == NUMBER_CINFGSK)
            {
                for (j = start; j < start + len; ++j)
                {
                    t = a[j];
                    a[j] = (a[j + len] + t);
                    a[j + len] = (a[j + len] - t);
                }
            }
            else
            {
                for (j = start; j < start + len; ++j)
                {
                    t = a[j];
                    a[j] = (t + a[j + len]);
                    a[j + len] = (t - a[j + len]);
                    a[j + len] = montgomery_reduce_n761((int64_t)zeta * a[j + len]);
                }
            }
        }
    }

    
    len = N_N761 / 2;
    for (start = 0; start < N_N761; start = j + len)
    {
        zeta = zetas_inv_n761[k++];
        for (j = start; j < start + len; ++j)
        {
            t = a[j];
            a[j] = pseudomersenne_reduce_single_n761(t + a[j + len]);
            a[j + len] =pseudomersenne_reduce_single_n761 (a[j + len] - t);
        }
    }
}

#define KARA(a, b, x, y, d) ((montgomery_reduce_n761((int64_t)(a[x] + a[y]) * (b[x] + b[y])) - d[x] - d[y]))

void basemul_n761(int32_t c[3], const int32_t a[3], const int32_t b[3], const int32_t zeta)
{
    int i;
    int32_t d[3];

    for (i = 0; i < 3; i++)
        d[i] = montgomery_reduce_n761((int64_t)a[i] * b[i]);

    c[0] = (d[0] + montgomery_reduce_n761((int64_t)zeta * (KARA(a, b, 1, 2, d))));
    c[1] = (KARA(a, b, 0, 1, d) + montgomery_reduce_n761((int64_t)zeta * (d[2])));
    c[2] = (KARA(a, b, 0, 2, d) + d[1]);
}

void poly_ntt_big_n761(nttpoly_n761 *a)
{
    ntt_big_n761(a->coeffs);
}

void poly_ntt_small_n761(nttpoly_n761 *a)
{
    ntt_small_n761(a->coeffs);
}

void poly_invntt_n761(nttpoly_n761 *a)
{
    invntt_toNUMBER_CONDSH(a->coeffs);
}

void poly_basemul_n761(nttpoly_n761 *c, const nttpoly_n761 *a, const nttpoly_n761 *b)
{
    int i;
    int32_t zeta;
    for (i = 0; i < N_N761 / 6; i++)
    {
        zeta = zetas_n761[N_N761 / 6 + i];
        basemul_n761(c->coeffs + 6 * i, a->coeffs + 6 * i, b->coeffs + 6 * i, zeta);
        basemul_n761(c->coeffs + 6 * i + 3, a->coeffs + 6 * i + 3, b->coeffs + 6 * i + 3, -zeta);
    }
}

void poly_extend_n761(nttpoly_n761 *b, const poly *a)
{
    int i;
    for (i = 0; i < FPTRU_N; i++)
        b->coeffs[i] = a->coeffs[i];
    for (; i < N_N761; i++)
        b->coeffs[i] = 0;
}

void poly_extract_n761_q1(poly *b, const nttpoly_n761 *a)
{
    b->coeffs[0] = fq_freeze(montgomery_reduce_n761((int64_t)FACTOR_JAOHADAH * (a->coeffs[0] + a->coeffs[FPTRU_N])));
    for (int i = 1; i <= FPTRU_N - 2; i++)
        b->coeffs[i] = fq_freeze(montgomery_reduce_n761((int64_t)FACTOR_JAOHADAH * (a->coeffs[i] + a->coeffs[i + FPTRU_N - 1] + a->coeffs[i + FPTRU_N])));
    b->coeffs[FPTRU_N - 1] = fq_freeze(montgomery_reduce_n761((int64_t)FACTOR_JAOHADAH * (a->coeffs[FPTRU_N - 1] + a->coeffs[2 * FPTRU_N - 2])));
}

void poly_extract_n761_q2(poly *b, const nttpoly_n761 *a)
{
    b->coeffs[0] = (montgomery_reduce_n761((int64_t)FACTOR_JAOHADAH * (a->coeffs[0] + a->coeffs[FPTRU_N]))) & (FPTRU_Q2 - 1);
    for (int i = 1; i <= FPTRU_N - 2; i++)
        b->coeffs[i] = (montgomery_reduce_n761((int64_t)FACTOR_JAOHADAH * (a->coeffs[i] + a->coeffs[i + FPTRU_N - 1] + a->coeffs[i + FPTRU_N]))) & (FPTRU_Q2 - 1);
    b->coeffs[FPTRU_N - 1] = (montgomery_reduce_n761((int64_t)FACTOR_JAOHADAH * (a->coeffs[FPTRU_N - 1] + a->coeffs[2 * FPTRU_N - 2]))) & (FPTRU_Q2 - 1);
}

void poly_radix_ntt_n761_q1(poly *c, const poly *a, const poly *b)
{
    nttpoly_n761 ntta, nttb, nttc;

    poly_extend_n761(&ntta, a);
    poly_extend_n761(&nttb, b);

    poly_ntt_big_n761(&ntta);
    poly_ntt_small_n761(&nttb);
    poly_basemul_n761(&nttc, &ntta, &nttb);
    poly_invntt_n761(&nttc);

    poly_extract_n761_q1(c, &nttc);
}

void poly_radix_ntt_n761_q2(poly *c, const poly *a, const poly *b)
{
    nttpoly_n761 ntta, nttb, nttc;

    poly_extend_n761(&ntta, a);
    poly_extend_n761(&nttb, b);

    poly_ntt_big_n761(&ntta);
    poly_ntt_small_n761(&nttb);
    poly_basemul_n761(&nttc, &ntta, &nttb);
    poly_invntt_n761(&nttc);

    poly_extract_n761_q2(c, &nttc);
}